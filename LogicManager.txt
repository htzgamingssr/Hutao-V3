local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:FindFirstChild("PlayerGui")

local survivorsFolder = Workspace:WaitForChild("Players"):WaitForChild("Survivors")
local killersFolder = Workspace:WaitForChild("Players"):WaitForChild("Killers")

local LogicManager = {}

LogicManager.Players = Players
LogicManager.ReplicatedStorage = ReplicatedStorage
LogicManager.Workspace = Workspace

LogicManager.LP = LocalPlayer
LogicManager.PlayerGui = PlayerGui

LogicManager.survivorsFolder = survivorsFolder
LogicManager.killersFolder = killersFolder

function LogicManager.IsSurvivor(obj)
    if not obj then return false end
    local folder = LogicManager.survivorsFolder
    if not folder then return false end

    return obj:IsA("Model")
        and obj.Parent == folder
        and obj:FindFirstChildOfClass("Humanoid")
end

function LogicManager.IsKiller(obj)
    if not obj then return false end
    local folder = LogicManager.killersFolder
    if not folder then return false end

    return obj:IsA("Model")
        and obj.Parent == folder
        and obj:FindFirstChildOfClass("Humanoid")
end

function LogicManager.GetCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

function LogicManager.GetHRP(character)
    character = character or LogicManager.GetCharacter()
    return character and character:FindFirstChild("HumanoidRootPart")
end

_G.LogicManager = LogicManager


getgenv().PizzaSystem = getgenv().PizzaSystem or {}

getgenv().PizzaSystem.AimbotEnabled = getgenv().PizzaSystem.AimbotEnabled or false
getgenv().PizzaSystem.AimDistance   = getgenv().PizzaSystem.AimDistance or 100

getgenv().PizzaSystem.AutoEatEnabled = getgenv().PizzaSystem.AutoEatEnabled or false
getgenv().PizzaSystem.HPThreshold    = getgenv().PizzaSystem.HPThreshold or 30

local RunService = game:GetService("RunService")
local Logic = _G.LogicManager

local PizzaAnimation = {
    ["114155003741146"] = true,
    ["104033348426533"] = true
}

local EliotModels = {["Elliot"] = true}

local autoRotateDisabled = false
local currentTarget, isLockedOn, wasPlayingAnimation = nil, false, false
local aimOffset = 2

local function isEliot()
    local char = Logic.GetCharacter()
    return char and EliotModels[char.Name]
end

local function getMyHumanoid()
    local char = Logic.GetCharacter()
    return char and char:FindFirstChildWhichIsA("Humanoid")
end

local function restoreRotate()
    local hum = getMyHumanoid()
    if hum and autoRotateDisabled then
        hum.AutoRotate = true
        autoRotateDisabled = false
    end
end

local function isPlayingPizzaAttack()
    local hum = getMyHumanoid()
    if not hum then return false end

    local animator = hum:FindFirstChildOfClass("Animator")
    if not animator then return false end

    for _, track in ipairs(animator:GetPlayingAnimationTracks()) do
        local id = tostring(track.Animation.AnimationId):match("%d+")
        if id and PizzaAnimation[id] then return true end
    end
    return false
end

local function getWeakestTarget()
    local list = {}
    local myChar = Logic.GetCharacter()
    local hum = getMyHumanoid()
    local root = Logic.GetHRP(myChar)
    if not root or not hum or hum.MaxHealth <= 0 then return nil end

    local myHp = hum.Health / hum.MaxHealth

    for _, obj in ipairs(Logic.survivorsFolder:GetChildren()) do
        if obj:IsA("Model") and obj ~= myChar then
            local h = obj:FindFirstChildWhichIsA("Humanoid")
            local hrp = Logic.GetHRP(obj)
            if h and hrp and h.Health > 0 then
                local dist = (hrp.Position - root.Position).Magnitude
                if dist <= getgenv().PizzaSystem.AimDistance then
                    table.insert(list, {model=obj, hp=h.Health/h.MaxHealth})
                end
            end
        end
    end

    table.sort(list, function(a,b) return a.hp < b.hp end)
    return list[1] and list[1].model or nil
end

local function getHRP()
    return Logic.GetHRP()
end

local function getHP()
    local hum = getMyHumanoid()
    return hum and hum.Health or 0
end

local function getPizzaCF()
    local map = Logic.Workspace:FindFirstChild("Map")
    local ingame = map and map:FindFirstChild("Ingame")
    if not ingame then return nil end

    local pizza = ingame:FindFirstChild("Pizza")
    if not pizza then return nil end

    if pizza:IsA("BasePart") then
        return pizza.CFrame
    elseif pizza:IsA("Model") then
        local pp = pizza.PrimaryPart or pizza:FindFirstChildWhichIsA("BasePart")
        if pp then return pp.CFrame end
    elseif pizza:IsA("CFrameValue") then
        return pizza.Value
    end
end

RunService.RenderStepped:Connect(function()
    if not getgenv().PizzaSystem.AimbotEnabled then
        restoreRotate()
        currentTarget, isLockedOn = nil, false
        return
    end

    if not isEliot() then
        restoreRotate()
        currentTarget, isLockedOn = nil, false
        return
    end

    local hum = getMyHumanoid()
    if not hum then return end
    local root = Logic.GetHRP()
    if not root then return end

    local attack = isPlayingPizzaAttack()

    if attack and not isLockedOn then
        currentTarget = getWeakestTarget()
        isLockedOn = currentTarget ~= nil
    end

    if isLockedOn and currentTarget then
        local h = currentTarget:FindFirstChildWhichIsA("Humanoid")
        local hrp = Logic.GetHRP(currentTarget)
        if not h or h.Health <= 0 or not hrp then
            currentTarget, isLockedOn = nil, false
        end
    end

    if not attack and wasPlayingAnimation then
        currentTarget, isLockedOn = nil, false
        restoreRotate()
    end

    wasPlayingAnimation = attack

    if attack and isLockedOn and currentTarget then
        local hrp = Logic.GetHRP(currentTarget)
        local targetPos = hrp.Position

        if not autoRotateDisabled then
            hum.AutoRotate = false
            autoRotateDisabled = true
        end

        if hrp.Velocity.Magnitude > 2 then
            targetPos += hrp.CFrame.LookVector * 3
        end

        local offset = root.CFrame.RightVector * aimOffset

        root.CFrame = root.CFrame:Lerp(
            CFrame.lookAt(root.Position, Vector3.new(targetPos.X, root.Position.Y, targetPos.Z) + offset),
            0.99
        )
    end
end)

task.spawn(function()
    while task.wait(0.9) do
        if getgenv().PizzaSystem.AutoEatEnabled then
            local hrp = getHRP()
            local pizza = getPizzaCF()
            if pizza and getHP() <= getgenv().PizzaSystem.HPThreshold then
                local old = hrp.CFrame
                hrp.CFrame = pizza * CFrame.new(0,1,0)

                task.wait(0.2)
                hrp.CFrame = old
                task.wait(0.3)
            end
        end
    end
end)



local Logic = _G.LogicManager
local animTrack = nil

getgenv().InvisibleSystem = getgenv().InvisibleSystem or {
    InstantEnabled = false,
    CloneEnabled = false
}

local function getHumanoid()
    local char = Logic.GetCharacter()
    return char:FindFirstChildOfClass("Humanoid"), char
end

local function getAnimator(humanoid)
    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then
        animator = Instance.new("Animator", humanoid)
    end
    return animator
end

local function playInvisibleAnim(humanoid)
    local animator = getAnimator(humanoid)
    if not animTrack or not animTrack.IsPlaying then
        local anim = Instance.new("Animation")
        anim.AnimationId = "rbxassetid://75804462760596"
        animTrack = animator:LoadAnimation(anim)
        animTrack.Looped = true
        animTrack:Play()
        animTrack:AdjustSpeed(0)
    end
end

local function stopInvisibleAnim()
    if animTrack and animTrack.IsPlaying then
        animTrack:Stop()
        animTrack = nil
    end
end

local function isSurvivorModel(char)
    return char and Logic.IsSurvivor(char)
end

task.spawn(function()
    while task.wait(0.4) do
        local humanoid, char = getHumanoid()
        if not humanoid or not char then
            stopInvisibleAnim()
        else
            if getgenv().InvisibleSystem.InstantEnabled and isSurvivorModel(char) then
                playInvisibleAnim(humanoid)
            elseif getgenv().InvisibleSystem.CloneEnabled then
                local torso = char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
                local root = Logic.GetHRP(char)
                if torso and torso.Transparency ~= 0 then
                    playInvisibleAnim(humanoid)
                    if root then root.Transparency = 0.4 end
                else
                    stopInvisibleAnim()
                    if root then root.Transparency = 1 end
                end
            else
                stopInvisibleAnim()
                local root = Logic.GetHRP(char)
                if root then root.Transparency = 1 end
            end
        end
    end
end)

Logic.Players.LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(1)
    local humanoid = char:WaitForChild("Humanoid")
    if getgenv().InvisibleSystem.InstantEnabled and isSurvivorModel(char) then
        playInvisibleAnim(humanoid)
    elseif getgenv().InvisibleSystem.CloneEnabled then
        local root = Logic.GetHRP(char)
        if root then root.Transparency = 0.4 end
        playInvisibleAnim(humanoid)
    end
end)

return true